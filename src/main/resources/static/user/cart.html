<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>我的购物车</title>
  <link rel="stylesheet" href="css/iconfont.css">
  <link rel="stylesheet" href="css/common.css">
  <link rel="stylesheet" href="stylus/personal.css">
  <link rel="stylesheet" href="stylus/cart.css">
</head>
<body>
<header id="header" >
  <div class="center">
    <div class="fr" style="position: relative;">
      <div class="user">
        <a href="/user/index.html" class="username">首页</a>
      </div>
      <div class="user">
        <a href="/user/qingbao" class="username">汽车情报站</a>
      </div>
      <div class="user">
        <a href="/user/index" class="username">选车</a>
      </div>
      <div class="user">
        <a href="/user/youhui" class="username">新车优惠</a>
      </div>
      <div class="user" style="color:red;width:200px">
        客服电话：12235037684
      </div>
    </div>
    <div class="fr" style="position: relative;">
      <div class="user">
        <ul class="selector">
          <li>
            <a href="/user/order">
              我的订单
            </a>
          </li>
          <li>
            <a href="/user/personal">
              个人中心
            </a>
          </li>

          <li>
            <a href="/user/logins">
              退出登录
            </a>
          </li>
        </ul>
        <a href="javascript:;" class="username" >
          <span id="userName"></span>
          <i class="iconfont icon-jiantou_xiangxia1"></i>
        </a>
      </div>
      <ul class="login" id="isLogin">
        <li><a href="/user/logins">登录</a></li>
        <li><a href="/user/regist">注册</a></li>
      </ul>
      <div class="shopcart" onclick="window.location.href = 'cart.html'">
        <i class="iconfont icon-cart"></i>

      </div>
    </div>
  </div>
</header>
<div id="cart">
  <div class="banner_x center">
<!--    <a href="./index.html" target="_blank">-->
<!--      <div class="logo fl"></div>-->
<!--    </a>-->

    <div class="wdgwc fl ml40">我的购物车</div>
    <div class="wxts fl ml20">温馨提示：产品是否购买成功，以最终下单为准哦，请尽快结算</div>
<!--    <div class="dlzc fr">-->
<!--      <div class="user">-->
<!--        <ul class="selector">-->
<!--          <li>-->
<!--            <a href="/user/personal">-->
<!--              个人中心-->
<!--            </a>-->
<!--          </li>-->

<!--          <li>-->
<!--            <a href="/user/logins">-->
<!--              退出登录-->
<!--            </a>-->
<!--          </li>-->
<!--        </ul>-->
<!--        <a href="javascript:;" class="username">-->
<!--          七月-->
<!--          <i class="iconfont icon-jiantou_xiangxia1"></i>-->
<!--        </a>-->
<!--      </div>-->
<!--      <ul class="login">-->
<!--        <li><a href="">登录</a></li>-->
<!--        <li><a href="">注册</a></li>-->
<!--      </ul>-->
<!--    </div>-->
    <div class="clear"></div>
  </div>
  <div class="xiantiao"></div>
  <div class="gwcxqbj">
    <div class="gwcxd center" id="content">
      <div class="top2 center">
        <div class="sub_top fl">
<!--          <input type="checkbox" value="quanxuan" class="quanxuan"/>全选-->
          商品图片
        </div>
        <div class="sub_top fl">商品名称</div>
        <div class="sub_top fl">单价</div>
        <div class="sub_top fl">数量</div>
        <div class="sub_top fl">小计</div>
        <div class="sub_top fr">操作</div>
        <div class="clear"></div>
      </div>
<!--      <div class="content2 center">-->
<!--        <div class="sub_content fl ">-->
<!--          <input type="checkbox" value="quanxuan" class="quanxuan"/>-->
<!--        </div>-->
<!--        <div class="sub_content fl"><img src="./image/cart/gwc_xiaomi6.jpg"></div>-->
<!--        <div class="sub_content fl ft20">小米6全网通6GB内存+64GB 亮黑色</div>-->
<!--        <div class="sub_content fl ">2499元</div>-->
<!--        <div class="sub_content fl">-->
<!--          <input class="shuliang" type="number" value="1" step="1" min="1">-->
<!--        </div>-->
<!--        <div class="sub_content fl">2499元</div>-->
<!--        <div class="sub_content fl"><a href="">×</a></div>-->
<!--        <div class="clear"></div>-->
<!--      </div>-->
<!--      <div class="content2 center">-->
<!--        <div class="sub_content fl ">-->
<!--          <input type="checkbox" value="quanxuan" class="quanxuan"/>-->
<!--        </div>-->
<!--        <div class="sub_content fl"><img src="./image/cart/gwc_xiaomi6.jpg"></div>-->
<!--        <div class="sub_content fl ft20">小米6全网通6GB内存+64GB 亮黑色</div>-->
<!--        <div class="sub_content fl ">2499元</div>-->
<!--        <div class="sub_content fl">-->
<!--          <input class="shuliang" type="number" value="1" step="1" min="1">-->
<!--        </div>-->
<!--        <div class="sub_content fl">2499元</div>-->
<!--        <div class="sub_content fl"><a href="">×</a></div>-->
<!--        <div class="clear"></div>-->
<!--      </div>-->
    </div>
    <div class="jiesuandan mt20 center">
      <div class="tishi fl ml20">
        <ul>
          <li><a href="./index.html">继续购物</a></li>
          <li>|</li>
          <li>共<span id="size"></span>件商品</li>
          <div class="clear"></div>
        </ul>
      </div>
      <div class="jiesuan fr">
        <div class="jiesuanjiage fl">合计：<span id="heji">2499.00元</span></div>
        <div class="jsanniu fr"><input class="jsan" type="button" id="jiesuan" value="去结算" onclick="addOrder()"/></div>
        <div class="clear"></div>
      </div>
      <div class="clear"></div>
    </div>
  </div>
</div>

</body>

<script src="../public/libs/jquery.min.js"></script>
<script>
  var isLogin=sessionStorage.getItem("userName");
  var cartId = null
  $(function () {
    if (isLogin==null || isLogin==""){
      alert("请先登录");
      window.location.href="/user/logins";
    }else {
      $.ajax({
        type: "get",
        url: "/user/userInfo",
        data: {"userName":isLogin},
        dataType: "json",
        contentType: "application/json",
        cache: false,
        async: false,
        success: function(result){
          $("#userName").html("欢迎您:"+isLogin);
          $("#isLogin").css("display","none");
          $("#out").css("display","block");

          $.ajax({
            type: "get",
            url: "/cart/add",
            dataType: "json",
            data: {userid: result.userId},
            contentType: "application/json",
            cache: false,
            async: false,
            success: function (r) {
              cartId = r.id
              $.ajax({
                type: "get",
                url: "/cart/list",
                dataType: "json",
                data: {record: r.id},
                contentType: "application/json",
                cache: false,
                async: false,
                success: function (r) {
                    var html = '';
                    var size = 0;
                    var price = 0
                    for (var index in r.data){
                      var item = r.data[index]
                      html += '<div class="content2 center">\n' +
                              // '        <div class="sub_content fl ">\n' +
                              // '          <input type="checkbox" value="quanxuan" class="quanxuan"/>\n' +
                              // '        </div>\n' +
                              '        <div class="sub_content fl" style="width:100px"><img src="/back-img/' + item.img + '" style="width:100%;height: 100%;"></div>\n' +
                              '        <div class="sub_content fl ft20" style="margin-left: 100px;">' + item.goodsName + '</div>\n' +
                              '        <div class="sub_content fl " style="margin-left: 330px;width: 130px">' + item.goodsPrice + '元</div>\n' +
                              '        <div class="sub_content fl">\n' +
                              '          <input class="shuliang" type="number" step="1" min="1" value="' + item.qty + '">\n' +
                              '          <input class="pric" type="hidden" value="' + item.goodsPrice + '">' +
                              '          <input class="cid" type="hidden" value="' + item.id + '">' +
                              '        </div>\n' +
                              '        <div class="sub_content fl xiaoji">' + item.goodsTotalPrice + '元</div>\n' +
                              '        <div class="sub_content fl"><a href="javascript:del(' + item.id + ')">×</a></div>\n' +
                              '        <div class="clear"></div>\n' +
                              '      </div>'
                      size += item.qty
                      price += item.goodsTotalPrice
                    }

                    $("#content").append(html)
                  $("#size").text(size)
                  $("#heji").text(price + "元")


                  $(".shuliang").change(function(){
                    var size1 = 0;
                    var price1 = 0;
                    var that = this;
                    $(that).parent().parent().find(".xiaoji").text(Number($(that).val())*Number($(that).parent().find(".pric").val()) + "元");

                    //合计
                    $(".shuliang").each(function(index, v){
                      size1 += Number($(v).val())
                      price1 += Number($(v).parent().find(".pric").val()) * Number($(v).val())
                    })
                    $("#size").text(size1)
                    $("#heji").text(price1 + "元")

                    $.ajax({
                      type: "get",
                      url: "/cart/update/qty",
                      dataType: "json",
                      data: {
                        id: $(that).parent().find(".cid").val(),
                        qty: $(that).val(),
                        price: Number($(that).val())*Number($(that).parent().find(".pric").val())
                      },
                      contentType: "application/json",
                      cache: false,
                      async: false,
                      success: function (r) {
                        console.log(r)
                      }
                    })
                  })
                }
              })
            }
          });
        }
      });
    }



  });

  function del(id){
    $.ajax({
      type: "get",
      url: "/cart/del/item",
      dataType: "json",
      data: {id: id},
      contentType: "application/json",
      cache: false,
      async: false,
      success: function (r) {
        window.location.reload();
      }
    });
  }

  function addOrder(){
    // var ids = []
    // $(".cid").each(function(i, v){
    //   ids.push(Number($(v).val()))
    // })
    // $.ajax({
    //   type: "get",
    //   url: "/cart/add/cart",
    //   dataType: "json",
    //   data: {username: isLogin, ids: ids},
    //   contentType: "application/json",
    //   cache: false,
    //   async: false,
    //   success: function (r) {
    //     window.location.reload();
    //   }
    // });
    window.location.href="settlement2.html?id=" + cartId;
  }
</script>
</html>
